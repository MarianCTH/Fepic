<header class="header-top">
    <nav class="navbar navbar-light">
        <div class="navbar-left">
            <div class="logo-area">
                <a class="navbar-brand" href="index.php">
                    <img class="dark" src="img/logo-dark.png" alt="logo">
                    <img class="light" src="img/logo-white.png" alt="logo">
                </a>
                <a href="index.php" class="sidebar-toggle">
                    <img class="svg" src="img/svg/align-center-alt.svg" alt="img"></a>
            </div>
            <a href="#" class="customizer-trigger">
                <i class="uil uil-edit-alt"></i>
                <span>Personalinează...</span>
            </a>
            <div class="top-menu">
                <div class="hexadash-top-menu position-relative">
                    <ul class="d-flex align-items-center flex-wrap">
                        <li class="has-subMenu">
                            <a href="#" class>Principal</a>
                            <ul class="subMenu">
                                <li class="l_sidebar">
                                    <a href="index.php"><span class="nav-icon uil uil-create-dashboard"></span>Panou
                                        Principal</a>
                                    <a href="changelog.php"><span
                                            class="nav-icon uil uil-arrow-growth"></span>Actualizări</a>
                                    <a href="activity.php"><span
                                            class="nav-icon uil uil-clipboard"></span>Activitate</a>
                                </li>
                            </ul>
                        </li>
                        <li class="has-subMenu">
                            <a href="#" class>CRUD</a>
                            <ul class="subMenu">
                                <li class="l_sidebar">
                                    <a href="users.php"><span class="nav-icon uil uil-users-alt"></span>Utilizatori</a>
                                </li>
                                <li class="l_sidebar">
                                    <a href="admin_list.php"><span
                                            class="nav-icon uil uil-user-md"></span>Administratori</a>
                                </li>
                                <li class="has-subMenu-left">
                                    <a href="#" class>
                                        <span class="nav-icon uil uil-envelope"></span> <span
                                            class="menu-text">Cereri</span>
                                    </a>
                                    <ul class="subMenu">
                                        <li>
                                            <a href="requests.php" class>Cereri de contact</a>
                                        </li>
                                    </ul>
                                </li>
                                
                                <li class="l_sidebar">
                                    <a href="chat.php"><span class="nav-icon uil uil-chat"></span>Chat BOT</a>
                                </li>
                            </ul>
                        </li>
                        <li class="has-subMenu">
                            <a href="#" class>Blog</a>
                            <ul class="subMenu">
                                <li class="l_sidebar">
                                    <a href="new-post.php"><span class="nav-icon uil uil-plus-square"></span>Postare
                                        nouă</a>
                                </li>
                                <li class="l_sidebar">
                                    <a href="blogs.php"><span
                                            class="nav-icon uil uil-document-layout-left"></span>Postări</a>
                                </li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="navbar-right">
            <ul class="navbar-right__menu">
                <!--
                <li class="nav-message">
                    <div class="dropdown-custom">
                        <a href="javascript:;" class="nav-item-toggle icon-active">
                            <img class="svg" src="img/svg/message.svg" alt="img">
                        </a>
                        <div class="dropdown-parent-wrapper">
                            <div class="dropdown-wrapper">
                                <h2 class="dropdown-wrapper__title">Messages <span
                                        class="badge-circle badge-success ms-1">2</span></h2>
                                <ul>
                                    <li class="author-online has-new-message">
                                        <div class="user-avater">
                                            <img src="img/team-1.png" alt>
                                        </div>
                                        <div class="user-message">
                                            <p>
                                                <a href class="subject stretched-link text-truncate"
                                                    style="max-width: 180px;">Web Design</a>
                                                <span class="time-posted">3 hrs ago</span>
                                            </p>
                                            <p>
                                                <span class="desc text-truncate" style="max-width: 215px;">Lorem
                                                    ipsum
                                                    dolor amet cosec Lorem ipsum</span>
                                                <span class="msg-count badge-circle badge-success badge-sm">1</span>
                                            </p>
                                        </div>
                                    </li>
                                    <li class="author-offline has-new-message">
                                        <div class="user-avater">
                                            <img src="img/team-1.png" alt>
                                        </div>
                                        <div class="user-message">
                                            <p>
                                                <a href class="subject stretched-link text-truncate"
                                                    style="max-width: 180px;">Web Design</a>
                                                <span class="time-posted">3 hrs ago</span>
                                            </p>
                                            <p>
                                                <span class="desc text-truncate" style="max-width: 215px;">Lorem
                                                    ipsum
                                                    dolor amet cosec Lorem ipsum</span>
                                                <span class="msg-count badge-circle badge-success badge-sm">1</span>
                                            </p>
                                        </div>
                                    </li>
                                    <li class="author-online has-new-message">
                                        <div class="user-avater">
                                            <img src="img/team-1.png" alt>
                                        </div>
                                        <div class="user-message">
                                            <p>
                                                <a href class="subject stretched-link text-truncate"
                                                    style="max-width: 180px;">Web Design</a>
                                                <span class="time-posted">3 hrs ago</span>
                                            </p>
                                            <p>
                                                <span class="desc text-truncate" style="max-width: 215px;">Lorem
                                                    ipsum
                                                    dolor amet cosec Lorem ipsum</span>
                                                <span class="msg-count badge-circle badge-success badge-sm">1</span>
                                            </p>
                                        </div>
                                    </li>
                                    <li class="author-offline">
                                        <div class="user-avater">
                                            <img src="img/team-1.png" alt>
                                        </div>
                                        <div class="user-message">
                                            <p>
                                                <a href class="subject stretched-link text-truncate"
                                                    style="max-width: 180px;">Web Design</a>
                                                <span class="time-posted">3 hrs ago</span>
                                            </p>
                                            <p>
                                                <span class="desc text-truncate" style="max-width: 215px;">Lorem
                                                    ipsum
                                                    dolor amet cosec Lorem ipsum</span>
                                            </p>
                                        </div>
                                    </li>
                                    <li class="author-offline">
                                        <div class="user-avater">
                                            <img src="img/team-1.png" alt>
                                        </div>
                                        <div class="user-message">
                                            <p>
                                                <a href class="subject stretched-link text-truncate"
                                                    style="max-width: 180px;">Web Design</a>
                                                <span class="time-posted">3 hrs ago</span>
                                            </p>
                                            <p>
                                                <span class="desc text-truncate" style="max-width: 215px;">Lorem
                                                    ipsum
                                                    dolor amet cosec Lorem ipsum</span>
                                            </p>
                                        </div>
                                    </li>
                                </ul>
                                <a href class="dropdown-wrapper__more">See All Message</a>
                            </div>
                        </div>
                    </div>
                </li>
-->
                <?php
                require_once 'php/notifications/notificari.php';
                $notifications = getNotifications('Administrator'); ?>
                <li id="notification-icon" <?php
                if (count($notifications) > 0)
                    echo 'class="nav-notification"'; ?>>
                    <div class="dropdown-custom">
                        <a href="javascript:;" class="nav-item-toggle">
                            <img class="svg" src="img/svg/alarm.svg" alt="img">
                        </a>
                        <div class="dropdown-parent-wrapper">
                            <div class="dropdown-wrapper">

                                <h2 class="dropdown-wrapper__title">Notificări
                                    <?php if (count($notifications) > 0)
                                        echo '<span
                                        class="badge-circle badge-warning ms-1">' . count($notifications) . '</span>'; ?>
                                </h2>
                                <ul>
                                    <li class="no-notifications"
                                        style="text-align:center; margin-bottom:1rem; display:none;">Nici o notificare
                                        existentă</li>
                                    <?php

                                    if (count($notifications) === 0) {
                                        echo '<li class="no-notifications" style="text-align:center; margin-bottom:1rem;">Nici o notificare existentă</li>';
                                    } else {
                                        foreach ($notifications as $notification) {

                                            echo '
                <li class="nav-notification__single nav-notification__single--unread d-flex flex-wrap" data-notification-id="' . $notification['id'] . '">';
                                            if ($notification['type'] == 'new_acc')
                                                echo '<div class="nav-notification__type nav-notification__type--success"><img class="svg" src="img/svg/log-in.svg" alt="log-in"></div>';
                                            else if ($notification['type'] == 'update')
                                                echo '<div class="nav-notification__type nav-notification__type--primary"><img class="svg" src="img/svg/upload.svg" alt="inbox"></div>';
                                            else if ($notification['type'] == 'contact_request')
                                                echo '<div class="nav-notification__type nav-notification__type--primary"><img class="svg" src="img/svg/message.svg" alt="inbox"></div>';
                                            else if ($notification['type'] == 'like')
                                                echo '<div class="nav-notification__type nav-notification__type--danger"><img src="img/svg/heart.svg" alt="heart" class="svg"></div>';
                                            else if ($notification['type'] == 'delete_acc')
                                                echo '<div class="nav-notification__type nav-notification__type--danger"><img src="img/svg/x.svg" alt="heart" class="svg"></div>';
                                            echo '<div class="nav-notification__details">
                        <p>
                            <span>' . $notification['message'] . '</span>
                        </p>
                        <p>
                        <span class="time-posted">' . getTimeAgo($notification['timestamp']) . '</span>

                        </p>
                    </div>
                </li>';
                                        }
                                    }
                                    ?>
                                </ul>
                                <?php if (count($notifications) > 0)
                                    echo '<a href="activity.php" class="dropdown-wrapper__more">Vezi toată activitatea</a>'; ?>
                            </div>
                        </div>
                    </div>
                </li>
                <!--
                <li class="nav-flag-select">
                    <div class="dropdown-custom">
                        <a href="javascript:;" class="nav-item-toggle"><img src="img/flag.png" alt
                                class="rounded-circle"></a>
                        <div class="dropdown-parent-wrapper">
                            <div class="dropdown-wrapper dropdown-wrapper--small">
                                <a href><img src="img/eng.png" alt> English</a>
                                <a href><img src="img/ger.png" alt> German</a>
                                <a href><img src="img/spa.png" alt> Spanish</a>
                                <a href><img src="img/tur.png" alt> Turkish</a>
                                <a href><img src="img/iraq.png" alt> Arabic</a>
                            </div>
                        </div>
                    </div>
                </li>
-->
                <?php

                $ID_user = isset($_SESSION["id"]) ? $_SESSION["id"] : 0;

                $query = "SELECT * FROM `utilizatori` WHERE `ID` = $ID_user";
                $result = mysqli_query($db, $query);

                if (!$result) {
                    die("Query execution failed: " . mysqli_error($db));
                }

                $user = mysqli_fetch_assoc($result);

                ?>

                <li class="nav-author">
                    <div class="dropdown-custom">
                        <a href="javascript:;" class="nav-item-toggle"><img
                                src="../images/profile/<?php echo $user['Poza']; ?>" alt class="rounded-circle">
                            <span class="nav-item__title">
                                <?php echo $user['Nume']; ?><i class="las la-angle-down nav-item__arrow"></i>
                            </span>
                        </a>
                        <div class="dropdown-parent-wrapper">
                            <div class="dropdown-wrapper">
                                <div class="nav-author__info">
                                    <div class="author-img">
                                        <img src="../images/profile/<?php echo $user['Poza']; ?>" alt
                                            class="rounded-circle">
                                    </div>
                                    <div>
                                        <h6>
                                            <?php echo $user['Nume'] . ' ' . $user['Prenume'];
                                            ; ?>
                                        </h6>
                                        <span>
                                            <?php echo $user['Rol']; ?>
                                        </span>
                                    </div>
                                </div>
                                <div class="nav-author__options">
                                    <ul>
                                        <li>
                                            <a href="../profile.php">
                                                <i class="uil uil-user"></i> Profil</a>
                                        </li>
                                    </ul>
                                    <a href="../sign-out.php" class="nav-author__signout">
                                        <i class="uil uil-sign-out-alt"></i> Sign Out</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </li>

            </ul>

            <div class="navbar-right__mobileAction d-md-none">
                <a href="#" class="btn-author-action">
                    <img class="svg" src="img/svg/more-vertical.svg" alt="more-vertical"></a>
            </div>
        </div>

    </nav>
</header>

<script>
    function deleteNotification(notificationId, callback) {
        var xhr = new XMLHttpRequest();
        xhr.open('POST', 'php/notifications/delete_notification.php', true);
        xhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
        xhr.onreadystatechange = function () {
            if (xhr.readyState === 4 && xhr.status === 200) {
                var response = xhr.responseText;
                if (response === 'success') {
                    var item = document.querySelector('[data-notification-id="' + notificationId + '"]');
                    if (item) {
                        item.remove();
                    }
                    if (typeof callback === 'function') {
                        callback();
                    }
                }
                else {
                    console.error('Error deleting notification:', response);
                }
            }
        };
        xhr.send('action=deleteNotification&notificationId=' + notificationId);
    }


    function updateNotificationCount() {
        var countElement = document.querySelector('.badge-circle');
        var notificationItems = document.querySelectorAll('.nav-notification__single');
        var count = notificationItems.length;

        if (countElement) {
            if (count > 0) {
                countElement.textContent = count;
                countElement.style.display = 'inline-block';
                var noNotificationsElement = document.querySelector('.no-notifications');

                if (noNotificationsElement) {
                    noNotificationsElement.style.display = 'none';
                }

                var navItemToggle = document.querySelector('a.nav-item-toggle');
                if (navItemToggle) {
                    navItemToggle.classList.add('icon-active');
                    var notificationIcon = document.getElementById("notification-icon");

                    notificationIcon.classList.add("nav-notification");
                }
            }
            else {
                countElement.style.display = 'none';
                var noNotificationsElement = document.querySelector('.no-notifications');
                if (noNotificationsElement) {
                    noNotificationsElement.style.display = 'block';
                }
                var navItemToggle = document.querySelector('a.nav-item-toggle');

                if (navItemToggle) {
                    navItemToggle.classList.remove('icon-active');

                    var notificationIcon = document.getElementById("notification-icon");
                    notificationIcon.classList.remove("nav-notification");

                }
            }
        }
    }

    var initialNotificationCount = document.querySelectorAll('.nav-notification__single').length;
    if (initialNotificationCount > 0) {
        var navItemToggle = document.querySelector('a.nav-item-toggle');
        if (navItemToggle) {
            navItemToggle.classList.add('icon-active');
        }
    }

    var notificationItems = document.querySelectorAll('.nav-notification__single');
    notificationItems.forEach(function (item) {
        item.addEventListener('click', function (event) {
            event.preventDefault();
            var notificationId = this.getAttribute('data-notification-id');

            deleteNotification(notificationId, updateNotificationCount);
        });
    });
</script>